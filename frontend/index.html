<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div id="app"></div>

    <script>
        const API_URL = 'http://localhost:5000/api/v1';
        let currentUser = null;
        let currentToken = '';
        let tasks = [];

        function showMessage(type, message) {
            const container = document.getElementById('message-container');
            const div = document.createElement('div');
            div.className = `${type === 'error' ? 'bg-red-50 border-red-200 text-red-700' : 'bg-green-50 border-green-200 text-green-700'} border px-4 py-3 rounded-lg mb-4 flex items-center gap-2`;
            div.innerHTML = `<span>${message}</span>`;
            container.innerHTML = '';
            container.appendChild(div);
            setTimeout(() => div.remove(), 5000);
        }

        async function register(username, email, password) {
            try {
                const res = await fetch(`${API_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message);
                
                currentUser = data.data.user;
                currentToken = data.data.token;
                showMessage('success', 'Registration successful!');
                renderDashboard();
                fetchTasks();
            } catch (err) {
                showMessage('error', err.message);
            }
        }

        async function login(email, password) {
            try {
                const res = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message);
                
                currentUser = data.data.user;
                currentToken = data.data.token;
                showMessage('success', 'Login successful!');
                renderDashboard();
                fetchTasks();
            } catch (err) {
                showMessage('error', err.message);
            }
        }

        async function fetchTasks(status = '') {
            try {
                const url = status ? `${API_URL}/tasks?status=${status}` : `${API_URL}/tasks`;
                const res = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message);
                
                tasks = data.data.tasks;
                renderTasks();
            } catch (err) {
                showMessage('error', err.message);
            }
        }

        async function createTask(title, description, priority) {
            try {
                const res = await fetch(`${API_URL}/tasks`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify({ title, description, priority })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message);
                
                showMessage('success', 'Task created successfully!');
                document.getElementById('task-title').value = '';
                document.getElementById('task-description').value = '';
                document.getElementById('task-priority').value = 'medium';
                fetchTasks();
            } catch (err) {
                showMessage('error', err.message);
            }
        }

        async function updateTask(taskId, updates) {
            try {
                const res = await fetch(`${API_URL}/tasks/${taskId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify(updates)
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message);
                
                showMessage('success', 'Task updated successfully!');
                fetchTasks();
            } catch (err) {
                showMessage('error', err.message);
            }
        }

        async function deleteTask(taskId) {
            if (!confirm('Are you sure you want to delete this task?')) return;
            
            try {
                const res = await fetch(`${API_URL}/tasks/${taskId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message);
                
                showMessage('success', 'Task deleted successfully!');
                fetchTasks();
            } catch (err) {
                showMessage('error', err.message);
            }
        }

        function logout() {
            currentUser = null;
            currentToken = '';
            tasks = [];
            renderAuth();
        }

        function renderAuth() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8">
                        <h1 class="text-3xl font-bold text-gray-800 mb-2 text-center">Task Manager</h1>
                        <p class="text-gray-600 mb-6 text-center">Manage your tasks efficiently</p>
                        
                        <div id="message-container"></div>
                        
                        <div class="flex gap-2 mb-6">
                            <button onclick="showTab('login')" id="login-tab" class="flex-1 py-2 rounded-lg font-medium transition bg-blue-600 text-white">
                                Login
                            </button>
                            <button onclick="showTab('register')" id="register-tab" class="flex-1 py-2 rounded-lg font-medium transition bg-gray-100 text-gray-600">
                                Register
                            </button>
                        </div>
                        
                        <div id="login-form">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                    <input type="email" id="login-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="john@example.com" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                    <input type="password" id="login-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="••••••••" required>
                                </div>
                                <button onclick="handleLogin()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700">
                                    Login
                                </button>
                            </div>
                        </div>
                        
                        <div id="register-form" class="hidden">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                                    <input type="text" id="register-username" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="johndoe" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                    <input type="email" id="register-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="john@example.com" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                    <input type="password" id="register-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Min 8 chars with uppercase, number & special char" required>
                                </div>
                                <button onclick="handleRegister()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700">
                                    Register
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDashboard() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="min-h-screen bg-gray-50">
                    <nav class="bg-white shadow-sm border-b">
                        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                            <h1 class="text-2xl font-bold text-blue-600">Task Manager</h1>
                            <div class="flex items-center gap-4">
                                <span class="text-sm text-gray-600">
                                    Welcome, <span class="font-semibold">${currentUser.username}</span>
                                    ${currentUser.role === 'admin' ? '<span class="ml-2 px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded">Admin</span>' : ''}
                                </span>
                                <button onclick="logout()" class="flex items-center gap-2 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                                    Logout
                                </button>
                            </div>
                        </div>
                    </nav>

                    <div class="max-w-7xl mx-auto px-4 py-8">
                        <div id="message-container"></div>

                        <div class="bg-white rounded-xl shadow-md p-6 mb-6">
                            <h2 class="text-xl font-semibold mb-4">Create New Task</h2>
                            <div class="grid gap-4 md:grid-cols-2">
                                <div class="md:col-span-2">
                                    <input type="text" id="task-title" placeholder="Task title" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                </div>
                                <div class="md:col-span-2">
                                    <textarea id="task-description" placeholder="Task description (optional)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" rows="3"></textarea>
                                </div>
                                <div>
                                    <select id="task-priority" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                        <option value="low">Low Priority</option>
                                        <option value="medium" selected>Medium Priority</option>
                                        <option value="high">High Priority</option>
                                    </select>
                                </div>
                                <div>
                                    <button onclick="handleCreateTask()" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">
                                        Create Task
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-md p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-semibold">My Tasks</h2>
                                <select id="filter-status" onchange="handleFilterChange()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">All Tasks</option>
                                    <option value="pending">Pending</option>
                                    <option value="in_progress">In Progress</option>
                                    <option value="completed">Completed</option>
                                </select>
                            </div>
                            <div id="tasks-container"></div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderTasks() {
            const container = document.getElementById('tasks-container');
            if (!tasks || tasks.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-500">No tasks found. Create your first task above!</div>';
                return;
            }

            container.innerHTML = tasks.map(task => `
                <div class="border border-gray-200 rounded-lg p-4 mb-3 hover:shadow-md transition" id="task-${task.id}">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-semibold text-lg">${escapeHtml(task.title)}</h3>
                        <div class="flex gap-2">
                            <button onclick="editTask(${task.id})" class="p-2 text-blue-600 hover:bg-blue-50 rounded">
                                ✏️
                            </button>
                            <button onclick="deleteTask(${task.id})" class="p-2 text-red-600 hover:bg-red-50 rounded">
                                🗑️
                            </button>
                        </div>
                    </div>
                    ${task.description ? `<p class="text-gray-600 text-sm mb-3">${escapeHtml(task.description)}</p>` : ''}
                    <div class="flex gap-2 flex-wrap">
                        <span class="px-3 py-1 rounded-full text-xs font-medium ${getStatusClass(task.status)}">
                            ${task.status.replace('_', ' ').toUpperCase()}
                        </span>
                        <span class="px-3 py-1 rounded-full text-xs font-medium ${getPriorityClass(task.priority)}">
                            ${task.priority.toUpperCase()} PRIORITY
                        </span>
                    </div>
                </div>
            `).join('');
        }

        function editTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            const taskElement = document.getElementById(`task-${taskId}`);
            taskElement.innerHTML = `
                <div class="space-y-3">
                    <input type="text" id="edit-title-${taskId}" value="${escapeHtml(task.title)}" class="w-full px-3 py-2 border border-gray-300 rounded">
                    <textarea id="edit-desc-${taskId}" class="w-full px-3 py-2 border border-gray-300 rounded" rows="2">${escapeHtml(task.description || '')}</textarea>
                    <div class="flex gap-2 flex-wrap">
                        <select id="edit-status-${taskId}" class="px-3 py-2 border border-gray-300 rounded">
                            <option value="pending" ${task.status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="in_progress" ${task.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                            <option value="completed" ${task.status === 'completed' ? 'selected' : ''}>Completed</option>
                        </select>
                        <select id="edit-priority-${taskId}" class="px-3 py-2 border border-gray-300 rounded">
                            <option value="low" ${task.priority === 'low' ? 'selected' : ''}>Low</option>
                            <option value="medium" ${task.priority === 'medium' ? 'selected' : ''}>Medium</option>
                            <option value="high" ${task.priority === 'high' ? 'selected' : ''}>High</option>
                        </select>
                        <button onclick="saveTask(${taskId})" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                            Save
                        </button>
                        <button onclick="renderTasks()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
        }

        function saveTask(taskId) {
            const title = document.getElementById(`edit-title-${taskId}`).value;
            const description = document.getElementById(`edit-desc-${taskId}`).value;
            const status = document.getElementById(`edit-status-${taskId}`).value;
            const priority = document.getElementById(`edit-priority-${taskId}`).value;
            updateTask(taskId, { title, description, status, priority });
        }

        function showTab(tab) {
            const loginTab = document.getElementById('login-tab');
            const registerTab = document.getElementById('register-tab');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');

            if (tab === 'login') {
                loginTab.className = 'flex-1 py-2 rounded-lg font-medium transition bg-blue-600 text-white';
                registerTab.className = 'flex-1 py-2 rounded-lg font-medium transition bg-gray-100 text-gray-600';
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
            } else {
                loginTab.className = 'flex-1 py-2 rounded-lg font-medium transition bg-gray-100 text-gray-600';
                registerTab.className = 'flex-1 py-2 rounded-lg font-medium transition bg-blue-600 text-white';
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
            }
        }

        function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            if (email && password) {
                login(email, password);
            }
        }

        function handleRegister() {
            const username = document.getElementById('register-username').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            if (username && email && password) {
                register(username, email, password);
            }
        }

        function handleCreateTask() {
            const title = document.getElementById('task-title').value;
            const description = document.getElementById('task-description').value;
            const priority = document.getElementById('task-priority').value;
            if (title) {
                createTask(title, description, priority);
            }
        }

        function handleFilterChange() {
            const status = document.getElementById('filter-status').value;
            fetchTasks(status);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getStatusClass(status) {
            if (status === 'completed') return 'bg-green-100 text-green-700';
            if (status === 'in_progress') return 'bg-blue-100 text-blue-700';
            return 'bg-gray-100 text-gray-700';
        }

        function getPriorityClass(priority) {
            if (priority === 'high') return 'bg-red-100 text-red-700';
            if (priority === 'medium') return 'bg-yellow-100 text-yellow-700';
            return 'bg-green-100 text-green-700';
        }

        renderAuth();
    </script>
</body>
</html>